<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tomato Taste Test - Triple Elimination</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 100vh;
            overflow-y: auto;
        }

        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .setup-screen, .comparison-screen, .results-screen {
            display: none;
        }

        .setup-screen.active, .comparison-screen.active, .results-screen.active {
            display: block;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            background: #f0f0f0;
            border-radius: 10px;
            height: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .round-info {
            text-align: center;
            margin-bottom: 15px;
            color: #666;
            font-size: 13px;
        }

        .round-number {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 3px;
        }

        .instruction {
            text-align: center;
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .tomato-option {
            background: #f8f9fa;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 15px 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .tomato-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }

        .rank-label {
            font-size: 14px;
            font-weight: 600;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rank-best {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
            border-color: #d4af37 !important;
            transform: scale(1.05);
        }

        .rank-middle {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%) !important;
            border-color: #a8a8a8 !important;
        }

        .rank-worst {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a75c 100%) !important;
            border-color: #b8732d !important;
        }

        .next-button {
            margin-top: 20px;
        }

        .results-table {
            margin: 30px 0;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 8px;
        }

        .result-row.podium-1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 3px solid #d4af37;
        }

        .result-row.podium-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            border: 3px solid #a8a8a8;
        }

        .result-row.podium-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a75c 100%);
            border: 3px solid #b8732d;
        }

        .result-rank {
            font-weight: 700;
            color: #333;
            font-size: 20px;
            width: 50px;
        }

        .result-can {
            flex: 1;
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        .result-medal {
            font-size: 28px;
        }

        .export-area {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 20px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover {
            background: #5a6268;
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
                align-items: flex-start;
            }

            .container {
                padding: 15px 12px;
                border-radius: 0;
                margin-top: 0;
                max-height: 100vh;
                min-height: 100vh;
            }

            .comparison {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin-bottom: 12px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 3px;
            }

            .subtitle {
                margin-bottom: 10px;
                font-size: 11px;
            }

            .progress {
                height: 4px;
                margin-bottom: 10px;
            }

            .tomato-number {
                font-size: 28px;
                margin-bottom: 8px;
            }

            .tomato-option {
                padding: 10px 8px;
            }

            .select-btn {
                padding: 6px 8px;
                font-size: 11px;
            }

            .round-info {
                margin-bottom: 8px;
                font-size: 12px;
            }

            .round-number {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .instruction {
                margin-bottom: 8px;
                font-size: 12px;
            }

            .next-button {
                margin-top: 10px;
            }

            button {
                padding: 10px 16px;
                font-size: 14px;
            }

            #save-indicator {
                display: none;
            }

            input[type="text"] {
                padding: 10px;
                font-size: 15px;
                margin-bottom: 15px;
            }

            label {
                margin-bottom: 6px;
                font-size: 14px;
            }
        }

        @media (max-width: 400px) {
            .comparison {
                grid-template-columns: 1fr;
            }
        }

        @media (max-height: 750px) and (max-width: 600px) {
            .container {
                padding: 12px 10px;
            }

            h1 {
                font-size: 18px;
            }

            .subtitle {
                margin-bottom: 8px;
                font-size: 10px;
            }

            .round-info {
                margin-bottom: 6px;
            }

            .instruction {
                margin-bottom: 6px;
                font-size: 11px;
            }

            .comparison {
                margin-bottom: 10px;
                gap: 6px;
            }

            .tomato-number {
                font-size: 24px;
                margin-bottom: 6px;
            }

            .tomato-option {
                padding: 8px 6px;
            }

            .select-btn {
                padding: 5px 6px;
                font-size: 10px;
            }

            .next-button {
                margin-top: 8px;
            }

            button {
                padding: 9px 14px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div class="setup-screen active">
            <h1>üçÖ Tomato Taste Test</h1>
            <p class="subtitle">Two-phase ranking to find the top 3 pizza sauce tomatoes</p>

            <label for="taster-name">Your Name:</label>
            <input type="text" id="taster-name" placeholder="Enter your name" autocomplete="name">

            <button onclick="startTest()">Start Tasting</button>
        </div>

        <!-- Comparison Screen -->
        <div class="comparison-screen">
            <div class="progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <div class="round-info">
                <div class="round-number" id="round-number">Round 1</div>
                <div id="comparison-count">Comparison 1 of 6</div>
            </div>

            <p class="instruction" id="instruction">Step 1: Tap the BEST can</p>

            <div style="text-align: center; margin-bottom: 15px;">
                <small style="color: #28a745; font-size: 12px;" id="save-indicator">‚úì Progress auto-saved</small>
            </div>

            <div class="comparison" id="comparison-container"></div>

            <div class="button-group">
                <button class="button-secondary" id="clear-button" onclick="clearSelection()" style="display: none;">Clear Selection</button>
                <button class="next-button" id="next-button" onclick="nextComparison()" disabled>
                    Next Comparison
                </button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen">
            <h1>üèÜ Results Complete!</h1>
            <p class="subtitle">Thank you, <span id="result-taster-name"></span>!</p>

            <div class="results-table" id="results-table"></div>

            <p style="margin: 20px 0; color: #666; font-size: 14px;">
                Copy the CSV data below and text it to Kyle:
            </p>

            <div class="export-area" id="export-data"></div>

            <div class="button-group">
                <button onclick="copyResults()">Copy Results</button>
                <button class="button-secondary" onclick="resetTest()">Start Over</button>
            </div>
        </div>
    </div>

    <script>
        // ABOUTME: Triple-elimination tournament logic for tomato taste test
        // ABOUTME: Implements 3 rounds with best/worst selection to determine top 3 ranked tomatoes

        const TOTAL_CANS = 12;

        let tasterName = '';
        let currentPhase = 1; // Phase 1 or 2
        let currentComparison = 0;
        let currentCans = [];
        let selectedBest = null;
        let selectedWorst = null;

        // Track all comparison results
        let allResults = [];

        // Phase structure: 4 groups in Phase 1, 2 groups in Phase 2
        let phase1Pairings = []; // 4 groups of 3
        let phase2Pairings = []; // 2 groups of 3
        let canScores = {}; // Track cumulative scores for each can
        let finalRanking = [];

        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function saveState() {
            const state = {
                tasterName,
                currentPhase,
                currentComparison,
                allResults,
                phase1Pairings,
                phase2Pairings,
                canScores,
                finalRanking
            };
            localStorage.setItem('tomatoTasteTest', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('tomatoTasteTest');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    tasterName = state.tasterName;
                    currentPhase = state.currentPhase || 1;
                    currentComparison = state.currentComparison;
                    allResults = state.allResults;
                    phase1Pairings = state.phase1Pairings || [];
                    phase2Pairings = state.phase2Pairings || [];
                    canScores = state.canScores || {};
                    finalRanking = state.finalRanking || [];
                    return true;
                } catch (e) {
                    console.error('Failed to load saved state', e);
                    return false;
                }
            }
            return false;
        }

        function clearState() {
            localStorage.removeItem('tomatoTasteTest');
        }

        function initializeCanScores() {
            canScores = {};
            for (let i = 1; i <= TOTAL_CANS; i++) {
                canScores[i] = 0;
            }
        }

        function startTest() {
            const nameInput = document.getElementById('taster-name');
            tasterName = nameInput.value.trim();

            if (!tasterName) {
                alert('Please enter your name');
                return;
            }

            // Reset all state
            allResults = [];
            currentPhase = 1;
            currentComparison = 0;
            initializeCanScores();
            finalRanking = [];

            // Pre-generate Phase 1 pairings: 4 groups of 3
            const allCans = shuffleArray(Array.from({length: TOTAL_CANS}, (_, i) => i + 1));
            phase1Pairings = [
                allCans.slice(0, 3),
                allCans.slice(3, 6),
                allCans.slice(6, 9),
                allCans.slice(9, 12)
            ];

            phase2Pairings = []; // Will generate after Phase 1

            saveState();

            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.comparison-screen').classList.add('active');

            showComparison();
        }

        // Double refresh detection to clear localStorage
        let lastRefreshTime = localStorage.getItem('lastRefreshTime');
        const currentTime = Date.now();

        if (lastRefreshTime && (currentTime - parseInt(lastRefreshTime)) < 3000) {
            // Double refresh within 3 seconds - clear everything
            localStorage.clear();
            console.log('Double refresh detected - localStorage cleared!');
        } else {
            // Store this refresh time
            localStorage.setItem('lastRefreshTime', currentTime.toString());
        }

        // On page load, check for saved state
        window.addEventListener('DOMContentLoaded', () => {
            if (loadState()) {
                // Resume from saved state
                if (finalRanking.length > 0) {
                    // Already completed, show results
                    document.querySelector('.setup-screen').classList.remove('active');
                    showResults();
                } else {
                    // In progress, resume comparison
                    document.querySelector('.setup-screen').classList.remove('active');
                    document.querySelector('.comparison-screen').classList.add('active');
                    showComparison();
                }
            }
        });

        function generatePhase2Pairings() {
            // Get top 6 cans by score from Phase 1
            const sortedCans = Object.keys(canScores)
                .map(can => ({ can: parseInt(can), score: canScores[can] }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 6)
                .map(item => item.can);

            // Shuffle the top 6 and split into 2 groups of 3
            const shuffled = shuffleArray(sortedCans);
            phase2Pairings = [
                shuffled.slice(0, 3),
                shuffled.slice(3, 6)
            ];
        }

        function showComparison() {
            selectedBest = null;
            selectedSecond = null;
            selectedWorst = null;
            document.getElementById('next-button').disabled = true;

            // Determine which cans to show based on current phase
            if (currentPhase === 1) {
                currentCans = phase1Pairings[currentComparison];
            } else if (currentPhase === 2) {
                currentCans = phase2Pairings[currentComparison];
            } else if (currentPhase === 2.5) {
                // Validation round: show positions 2, 3, 4
                currentCans = finalRanking.slice(1, 4);
            } else if (currentPhase === 3) {
                // Tiebreaker: show top 3 tied cans
                currentCans = finalRanking.slice(0, 3);
            }

            renderComparison();
            updateProgress();
        }

        function renderComparison() {
            const container = document.getElementById('comparison-container');

            container.innerHTML = currentCans.map(can => `
                <div class="tomato-option" id="can-${can}" onclick="selectCan(${can})" style="cursor: pointer;">
                    <div class="tomato-number">${can}</div>
                    <div class="rank-label" id="rank-${can}"></div>
                </div>
            `).join('');

            // Update clear button visibility
            if (selectedBest || selectedWorst) {
                document.getElementById('clear-button').style.display = 'block';
            } else {
                document.getElementById('clear-button').style.display = 'none';
            }
        }

        let selectedSecond = null;

        function selectCan(can) {
            if (!selectedBest) {
                // Step 1: Select best
                selectedBest = can;
                updateCanDisplay(can, 'best', 'ü•á Best');
                document.getElementById('instruction').textContent = 'Step 2: Tap the SECOND BEST can';
                document.getElementById('clear-button').style.display = 'block';
            } else if (!selectedSecond && can !== selectedBest) {
                // Step 2: Select second best (worst is automatic)
                selectedSecond = can;
                updateCanDisplay(can, 'middle', 'ü•à Second');

                // Find the worst can (the remaining one)
                selectedWorst = currentCans.find(c => c !== selectedBest && c !== selectedSecond);
                updateCanDisplay(selectedWorst, 'worst', 'ü•â Third');

                document.getElementById('instruction').textContent = 'Ready! Click next to continue';
                document.getElementById('next-button').disabled = false;
            }
        }

        function updateCanDisplay(can, rank, label) {
            const canEl = document.getElementById(`can-${can}`);
            const rankEl = document.getElementById(`rank-${can}`);

            canEl.classList.remove('rank-best', 'rank-middle', 'rank-worst');
            canEl.classList.add(`rank-${rank}`);
            rankEl.textContent = label;

            // Dim non-selected cans when in step 2
            if (selectedBest && !selectedSecond) {
                currentCans.forEach(c => {
                    if (c !== selectedBest) {
                        document.getElementById(`can-${c}`).style.opacity = '0.7';
                    }
                });
            }
        }

        function clearSelection() {
            selectedBest = null;
            selectedSecond = null;
            selectedWorst = null;
            document.getElementById('instruction').textContent = 'Step 1: Tap the BEST can';
            document.getElementById('next-button').disabled = true;
            document.getElementById('clear-button').style.display = 'none';

            // Reset all cans
            currentCans.forEach(can => {
                const canEl = document.getElementById(`can-${can}`);
                const rankEl = document.getElementById(`rank-${can}`);
                canEl.classList.remove('rank-best', 'rank-middle', 'rank-worst');
                canEl.style.opacity = '1';
                rankEl.textContent = '';
            });
        }

        function nextComparison() {
            // Update scores: Best = 3 pts, Second = 2 pts, Third = 1 pt
            canScores[selectedBest] += 3;
            canScores[selectedSecond] += 2;
            canScores[selectedWorst] += 1;

            // Record results
            allResults.push({
                phase: currentPhase,
                comparison: currentComparison + 1,
                cans: [...currentCans],
                best: selectedBest,
                middle: selectedSecond,
                worst: selectedWorst
            });

            // Move to next comparison
            currentComparison++;

            // Determine what's next
            if (currentPhase === 1 && currentComparison < 4) {
                // Continue Phase 1 (4 comparisons total)
                saveState();
                showComparison();
            } else if (currentPhase === 1 && currentComparison >= 4) {
                // Transition to Phase 2
                currentPhase = 2;
                currentComparison = 0;
                generatePhase2Pairings();
                saveState();
                showComparison();
            } else if (currentPhase === 2 && currentComparison < 2) {
                // Continue Phase 2 (2 comparisons total)
                saveState();
                showComparison();
            } else if (currentPhase === 2) {
                // Phase 2 complete, move to Phase 2.5 (validation round)
                currentPhase = 2.5;
                currentComparison = 0;
                calculateFinalRanking();
                saveState();
                showComparison();
            } else if (currentPhase === 2.5) {
                // Validation round complete
                calculateFinalRanking();

                // Check for ties in top 3
                if (needsTiebreaker()) {
                    currentPhase = 3; // Tiebreaker phase
                    currentComparison = 0;
                    saveState();
                    showComparison();
                } else {
                    saveState();
                    showResults();
                }
            } else if (currentPhase === 3) {
                // Tiebreaker complete
                calculateFinalRanking();
                saveState();
                showResults();
            }
        }

        function calculateFinalRanking() {
            // Sort all cans by final score
            finalRanking = Object.keys(canScores)
                .map(can => ({ can: parseInt(can), score: canScores[can] }))
                .sort((a, b) => b.score - a.score)
                .map(item => item.can);
        }

        function needsTiebreaker() {
            if (currentPhase === 3) return false; // Already did tiebreaker

            const top3Scores = finalRanking.slice(0, 3).map(can => canScores[can]);

            // Check if any of the top 3 have the same score
            return top3Scores[0] === top3Scores[1] ||
                   top3Scores[1] === top3Scores[2] ||
                   top3Scores[0] === top3Scores[2];
        }

        function updateProgress() {
            if (currentPhase === 2.5) {
                // Validation round
                document.getElementById('round-number').textContent = 'Validation';
                document.getElementById('comparison-count').textContent = 'Comparison 7 of 7';
                document.getElementById('progress-bar').style.width = '100%';
            } else if (currentPhase === 3) {
                // Tiebreaker
                document.getElementById('round-number').textContent = 'Tiebreaker';
                document.getElementById('comparison-count').textContent = 'Breaking ties in top 3';
                document.getElementById('progress-bar').style.width = '100%';
            } else {
                const totalComparisons = 7;
                const completed = (currentPhase === 1 ? currentComparison : 4 + currentComparison);

                document.getElementById('round-number').textContent = `Phase ${Math.floor(currentPhase)}`;
                document.getElementById('comparison-count').textContent = `Comparison ${completed + 1} of ${totalComparisons}`;
                document.getElementById('progress-bar').style.width = ((completed / totalComparisons) * 100) + '%';
            }
        }

        function showResults() {
            document.querySelector('.comparison-screen').classList.remove('active');
            document.querySelector('.results-screen').classList.add('active');

            document.getElementById('result-taster-name').textContent = tasterName;

            // Display top 3
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const podiumClasses = ['podium-1', 'podium-2', 'podium-3'];
            const top3 = finalRanking.slice(0, 3);

            const resultsTable = document.getElementById('results-table');
            resultsTable.innerHTML = top3.map((can, index) => {
                const score = canScores[can];
                return `
                    <div class="result-row ${podiumClasses[index]}">
                        <div class="result-rank">#${index + 1}</div>
                        <div class="result-can">Can ${can} (${score} pts)</div>
                        <div class="result-medal">${medals[index]}</div>
                    </div>
                `;
            }).join('');

            // Generate CSV export
            const timestamp = new Date().toISOString();

            let csvLines = [];

            // Summary header
            csvLines.push('SUMMARY');
            csvLines.push(`Taster,FirstPlace,SecondPlace,ThirdPlace,FirstScore,SecondScore,ThirdScore,Timestamp`);
            csvLines.push(`${tasterName},${top3[0]},${top3[1]},${top3[2]},${canScores[top3[0]]},${canScores[top3[1]]},${canScores[top3[2]]},${timestamp}`);
            csvLines.push('');

            // Detailed comparison results
            csvLines.push('COMPARISON DETAILS');
            csvLines.push('Phase,Comparison,CansCompared,Best,Middle,Worst');
            allResults.forEach(result => {
                csvLines.push(`${result.phase},${result.comparison},"${result.cans.join('|')}",${result.best},${result.middle},${result.worst}`);
            });

            const csvData = csvLines.join('\n');
            document.getElementById('export-data').textContent = csvData;
        }

        function copyResults() {
            const exportText = document.getElementById('export-data').textContent;
            navigator.clipboard.writeText(exportText).then(() => {
                alert('Results copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        function resetTest() {
            clearState();
            document.querySelector('.results-screen').classList.remove('active');
            document.querySelector('.setup-screen').classList.add('active');
            document.getElementById('taster-name').value = '';

            // Reset all state variables
            tasterName = '';
            currentPhase = 1;
            currentComparison = 0;
            allResults = [];
            phase1Pairings = [];
            phase2Pairings = [];
            initializeCanScores();
            finalRanking = [];
        }
    </script>
</body>
</html>
